
- defaults:
    clean:
        force: true
    link:
        create: true
        force: true
        relink: true 
    shell:
        stderr: true
        stdout: true


- sudo:
    - shell:
        - description: Update grub
          command: >
              datestamp=$(date +%y%m%d%H%M);
              cp /etc/default/grub /etc/default/grub.$datestamp.bak;
              sed -i -E "
                  s/^GRUB_TIMEOUT_STYLE=.+/GRUB_TIMEOUT_STYLE=menu/;
                  s/^GRUB_TIMEOUT=.+/GRUB_TIMEOUT=5/;
                  s/^GRUB_CMDLINE_LINUX_DEFAULT.+/GRUB_CMDLINE_LINUX_DEFAULT=\"\"/
              " /etc/default/grub; 
              update-grub;


        - description: Disable CUPS
          command: >
              if systemctl is-active cups ; then
                  systemctl stop cups;
                  systemctl disable cups;
                  echo cups disabled;
              fi;
              if systemctl is-active cups-browsed ]; then
                  systemctl stop cups-browsed;
                  systemctl disable cups-browsed;
                  echo cups-browsed disabled;
              fi;
        

- clean: ['~/','~/bin','~/.config']


- create:
    - ~/bin
    - ~/bin/i3blocklets
    - ~/repos
    - ~/.themes


# TODO Can this flag be set by some other means?
- shell:
    - description: Create primary host flag
      command: touch ~/.primaryhost


- link:
    ~/:
        path: home/.*
        glob: true
    ~/bin/:
        path: lib/scripts/*
        glob: true
        exclude:
            - lib/scripts/LICENSE
            - lib/scripts/npdisksetup
            - lib/scripts/save-the-change
    ~/bin/quickemu:
        path: lib/quickemu/quickemu
        if: "which snap &&  snap list | grep '^qemu-virgil'"
    ~/.config: ~
    ~/Downloads: /tmp
    ~/tmp: /tmp
    ~/toby:
        path: /nfs/home/$USER
        ignore-missing: true
    ~/.vim: ~
    ~/VirtualBoxVMs:
        path: /mnt/vmdrive/$USER/virtualbox
        ignore-missing: true


- shell:
    - description: Download vim pathogen
      command: >
          DOTVIMAUTODIR="${PWD}/vim/autoload/";
          SHASUMFILE="${PWD}/sha256.sums";
          cd /tmp;
          curl -LSo "pathogen.vim" "https://tpo.pe/pathogen.vim";
          sha256sum --check --ignore-missing "$SHASUMFILE" && \
            mv "pathogen.vim" "$DOTVIMAUTODIR";

    - description: Install i3blocks blocklets
      command: >
        cd lib/my-i3blocklets;
        ./deploy;

    - description: Install theme files
      stdout: false
      command: >
          cd ~;
          ls .dotfiles/themes/*.tar.gz | head -n 1 | xargs tar -vxf;
