
- defaults:
    clean:
        force: true
    link:
        create: true
        force: true
        relink: true 
    shell:
        stderr: true
        stdout: true


- sudo:
    - link:
        /usr/local/bin/pip:
            path: /usr/bin/pip3
            force: false
            ignore-missing: true


    - shell:
        - description: Update sudoers
          command: >
              SOURCE=etc/sudoers-override;
              TARGET=/etc/sudoers.d/01-my-overrides;
              visudo -c -f ${SOURCE} &&
              VISUAL="cp ${SOURCE}" visudo -f ${TARGET}


        - description: Update grub
          command: >
              DATESTAMP=$(date +%y%m%d%H%M);
              cp /etc/default/grub /etc/default/grub.$DATESTAMP.bak &&
              sed -i -E "
                  s/^GRUB_TIMEOUT_STYLE=.+/GRUB_TIMEOUT_STYLE=menu/;
                  s/^GRUB_TIMEOUT=.+/GRUB_TIMEOUT=5/;
                  s/^GRUB_CMDLINE_LINUX_DEFAULT.+/GRUB_CMDLINE_LINUX_DEFAULT=\"\"/
              " /etc/default/grub && 
              update-grub


        - description: Disable CUPS
          command: >
              systemctl is-active cups &&
              systemctl stop cups &&
              systemctl disable cups &&
              echo "cups disabled" &&
              systemctl stop cups-browsed &&
              systemctl disable cups &&
              echo "cups-browsed disabled"

        - description: Add Microsoft .NET Core package signing key
          command: >
              cd /tmp && 
              wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release --short --release)/packages-microsoft-prod.deb" &&
              dpkg -i packages-microsoft-prod.deb
        
        - description: Add repo for steam
          command: yes | add-apt-repository multiverse

        - description: Add ppa for Regolith Desktop
          command: yes | add-apt-repository ppa:regolith-linux/release
        
        - description: Perform apt cache update
          command: apt-get update

        - description: Install packages
          command: packages/install-packages.py --tags $HOSTNAME $HOSTCAT

        - description: Configure qemu-virgil
          command: >
              which snap > /dev/null && snap list | grep -q '^qemu-virgil' &&
              (
                  snap connect qemu-virgil:audio-record &&
                  snap connect qemu-virgil:kvm &&
                  snap connect qemu-virgil:raw-usb &&
                  snap connect qemu-virgil:removable-media
              ) ||
              echo "qemu-virgil not installed... skipping."



- clean: ['~/','~/bin','~/.config']


- create:
    - ~/bin
    - ~/bin/i3blocklets
    - ~/repos
    - ~/.themes


# TODO Can this flag be set by some other means?
- shell:
    - description: Create primary host flag
      command: touch ~/.primaryhost


- link:
    ~/:
        path: home/.*
        glob: true
    ~/bin/:
        path: lib/scripts/*
        glob: true
        exclude:
            - lib/scripts/LICENSE
            - lib/scripts/npdisksetup
            - lib/scripts/save-the-change
    ~/bin/quickemu:
        path: lib/quickemu/quickemu
        if: "which snap &&  snap list | grep '^qemu-virgil'"
    ~/.config: ~
    ~/Downloads: /tmp
    ~/tmp: /tmp
    ~/toby:
        path: /nfs/home/$USER
        ignore-missing: true
    ~/.vim: ~
    ~/VirtualBoxVMs:
        path: /mnt/vmdrive/$USER/virtualbox
        ignore-missing: true


- shell:
    - description: Download vim pathogen
      command: >
          DOTVIMAUTODIR="${PWD}/vim/autoload/";
          SHASUMFILE="${PWD}/sha256.sums";
          cd /tmp &&
          curl -LSo "pathogen.vim" "https://tpo.pe/pathogen.vim" &&
          sha256sum --check --ignore-missing "$SHASUMFILE" && 
          mv "pathogen.vim" "$DOTVIMAUTODIR"

    - description: Install i3blocks blocklets
      command: >
        cd lib/my-i3blocklets &&
        ./deploy

    - description: Install theme files
      stdout: false
      command: >
          cd ~ &&
          ls .dotfiles/themes/*.tar.gz | head -n 1 | xargs tar -vxf


# Link root config files to mine
- sudo:
    - link:
        ~/:
            path: home/.*
            glob: true
            exclude:
                - home/.fehbg
                - home/.gitconfig
                - home/.gtkrc-2.0
                - home/.Xresources
        ~/.vim:
            path: vim

