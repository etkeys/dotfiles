
- defaults:
    clean:
        force: true
    link:
        create: true
        force: true
        relink: true 
    shell:
        stderr: true
        stdout: true


- sudo:
    - link:
        /usr/local/bin/pip:
            path: /usr/bin/pip3
            force: false
            ignore-missing: true

    

    - shell:
        - description: swap caps and escape key
          command: |
              NAME=swap-caps-esc &&
              KMAPFILE=${NAME}.kmap &&
              KMAPPATH=/usr/local/share &&
              SERVICEFILE=${NAME}.service &&
              SERVICEPATH=/usr/local/lib/systemd/system &&
              ( systemctl is-enabled ${SERVICEFILE} ||
              (
              mkdir -p {${KMAPPATH},${SERVICEPATH}} &&
              { cat <<- EOF > ${KMAPPATH}/${KMAPFILE}
              keymaps 0-127
              keycode  1 = CtrlL_Lock
              keycode 58 = Escape
              EOF
              } &&
              { cat <<- EOF > ${SERVICEPATH}/${SERVICEFILE}
              [Unit]
              Description=Apply key remapping to swap CapsLock and Escape keys
              After=console-setup.service

              [Service]
              Type=oneshot
              RemainAfterExit=no
              ExecStart=/usr/bin/loadkeys ${KMAPPATH}/${KMAPFILE}

              [Install]
              WantedBy=multi-user.target 
              EOF
              } &&
              systemctl enable --now ${SERVICEPATH}/${SERVICEFILE}
              ))


        - description: Update sudoers
          command: >
              SOURCE=etc/sudoers-override;
              TARGET=/etc/sudoers.d/01-my-overrides;
              visudo -c -f ${SOURCE} &&
              VISUAL="cp ${SOURCE}" visudo -f ${TARGET}


        - description: Update grub
          command: >
              DATESTAMP=$(date +%y%m%d%H%M);
              cp /etc/default/grub /etc/default/grub.$DATESTAMP.bak &&
              sed -i -E "
                  s/^GRUB_TIMEOUT_STYLE=.+/GRUB_TIMEOUT_STYLE=menu/;
                  s/^GRUB_TIMEOUT=.+/GRUB_TIMEOUT=5/;
                  s/^GRUB_CMDLINE_LINUX_DEFAULT.+/GRUB_CMDLINE_LINUX_DEFAULT=\"\"/
              " /etc/default/grub && 
              update-grub


        - description: Disable CUPS
          command: >
              systemctl is-enabled cups &&
              (
                  systemctl disable --now cups &&
                  echo "cups disabled" &&
                  systemctl disable --now cups-browsed &&
                  echo "cups-browsed disabled"
              ) ||
              echo "cups not enabled... skipping."


        - description: Add Microsoft .NET Core package signing key
          command: >
              cd /tmp && 
              wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release --short --release)/packages-microsoft-prod.deb" &&
              dpkg -i packages-microsoft-prod.deb
        
        - description: Add repo for steam
          command: yes | add-apt-repository multiverse

        - description: Add ppa for Regolith Desktop
          command: yes | add-apt-repository ppa:regolith-linux/release
        
        - description: Perform apt cache update
          command: apt-get update

        - description: Install packages
          command: packages/install-packages.py --tags $HOSTNAME $HOSTCAT

        - description: Configure qemu-virgil
          command: >
              (command -v snap && snap list qemu-virgil) >/dev/null 2>&1 &&
              (
                  snap connect qemu-virgil:audio-record &&
                  snap connect qemu-virgil:kvm &&
                  snap connect qemu-virgil:raw-usb &&
                  snap connect qemu-virgil:removable-media
              ) ||
              echo "qemu-virgil not installed... skipping."

        - description: Add installing user to kvm group
          command: adduser ${SUDO_USER} kvm



- clean: ['~/','~/bin','~/.config']


- create:
    - ~/bin
    - ~/bin/i3blocklets
    - ~/repos
    - ~/.themes


# TODO Can this flag be set by some other means?
- shell:
    - description: Create primary host flag
      command: touch ~/.primaryhost


- link:
    ~/:
        path: home/.*
        glob: true
    ~/bin/:
        path: lib/scripts/*
        glob: true
        exclude:
            - lib/scripts/LICENSE
            - lib/scripts/npdisksetup
            - lib/scripts/save-the-change
    ~/bin/quickemu:
        path: lib/quickemu/quickemu
        if: (command -v snap && snap list qemu-virgil) >/dev/null 2>&1
    ~/.config: ~
    ~/Downloads: /tmp
    ~/tmp: /tmp
    ~/toby:
        path: /nfs/home/$USER
        ignore-missing: true
    ~/.vim: ~
    ~/VirtualBoxVMs:
        path: /mnt/vmdrive/$USER/virtualbox
        ignore-missing: true


- shell:
    - description: Download vim pathogen
      command: >
          DOTVIMAUTODIR="${PWD}/vim/autoload/";
          SHASUMFILE="${PWD}/sha256.sums";
          cd /tmp &&
          curl -LSo "pathogen.vim" "https://tpo.pe/pathogen.vim" &&
          sha256sum --check --ignore-missing "$SHASUMFILE" && 
          mv "pathogen.vim" "$DOTVIMAUTODIR"

    - description: Install i3blocks blocklets
      command: >
        cd lib/my-i3blocklets &&
        ./deploy

    - description: Install theme files
      stdout: false
      command: >
          cd ~ &&
          ls .dotfiles/themes/*.tar.gz | head -n 1 | xargs tar -vxf


- sudo:
    - link:
        # Link root config files to mine
        ~/:
            path: home/.*
            glob: true
            exclude:
                - home/.fehbg
                - home/.gitconfig
                - home/.gtkrc-2.0
                - home/.Xresources
        ~/.vim:
            path: vim

        # Set up first choice link for qemu selection
        /usr/bin/qemu:
            path: /snap/qemu-virgil/current
            if: (command -v snap && snap list qemu-virgil) >/dev/null 2>&1
